services:
  # TimescaleDB - PostgreSQL extension untuk time-series data
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: smartfarming-timescaledb-dev
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: smartfarming
      POSTGRES_USER: smartfarming
      POSTGRES_PASSWORD: smartfarming123
      TZ: Asia/Jakarta
      PGTZ: Asia/Jakarta
    volumes:
      - timescaledb_data_dev:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    restart: unless-stopped
    networks:
      - smartfarming-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smartfarming -d smartfarming"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Backend NestJS Application (Development with Hot Reload)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: smartfarming-backend-dev
    ports:
      - "3001:3001"
    environment:
      # Timezone
      TZ: Asia/Jakarta
      
      # Database
      DATABASE_HOST: timescaledb
      DATABASE_PORT: 5432
      DATABASE_USER: smartfarming
      DATABASE_PASSWORD: smartfarming123
      DATABASE_NAME: smartfarming
      
      # Also set DB_ prefix for wait script
      DB_HOST: timescaledb
      DB_PORT: 5432
      DB_USERNAME: smartfarming
      DB_PASSWORD: smartfarming123
      DB_NAME: smartfarming
      
      # JWT
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      JWT_EXPIRES_IN: 15m
      JWT_REFRESH_SECRET: your-super-secret-refresh-key-change-in-production
      JWT_REFRESH_EXPIRES_IN: 7d
      
      # MQTT (HiveMQ Cloud)
      MQTT_BROKER_URL: mqtts://6da97578cebb460eab0c5e7cff55862d.s1.eu.hivemq.cloud:8883
      MQTT_USERNAME: smartfarming
      MQTT_PASSWORD: Smartfarming123
      
      # App
      NODE_ENV: development
      PORT: 3001
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./logs:/app/logs
      # Prevent node_modules from being overwritten
      - /app/node_modules
    restart: unless-stopped
    networks:
      - smartfarming-network
    depends_on:
      timescaledb:
        condition: service_healthy

  # pgAdmin4 - Database GUI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: smartfarming-pgadmin-dev
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@smartfarming.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    volumes:
      - pgadmin_data_dev:/var/lib/pgadmin
    restart: unless-stopped
    networks:
      - smartfarming-network
    depends_on:
      - timescaledb

volumes:
  timescaledb_data_dev:
    driver: local
  pgadmin_data_dev:
    driver: local

networks:
  smartfarming-network:
    driver: bridge
